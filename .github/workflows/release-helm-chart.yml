name: Release Helm Chart

on:
  push:
  pull_request:
    branches:
      - main
    types:
      - closed
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:
  lint-and-release:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    env:
      TARGET_BRANCH: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.ref || github.ref_name }}
      MERGE_COMMIT: ${{ github.event_name == 'pull_request' && github.event.pull_request.merge_commit_sha || github.sha }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ env.MERGE_COMMIT }}
          fetch-depth: 0

      - name: Prepare repository
        run: |
          git fetch origin "$TARGET_BRANCH"
          git checkout "$TARGET_BRANCH"
          git pull --ff-only origin "$TARGET_BRANCH"

      - name: Configure Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump chart version
        id: bump_version
        run: |
          chart_file="charts/paperless-ngx/Chart.yaml"
          current_version=$(grep '^version:' "$chart_file" | awk '{print $2}')
          IFS='.' read -r major minor patch <<<"$current_version"
          if [ -z "$major" ] || [ -z "$minor" ] || [ -z "$patch" ]; then
            echo "Unable to parse current chart version: $current_version" >&2
            exit 1
          fi
          if ! [[ $patch =~ ^[0-9]+$ ]]; then
            echo "Chart patch version must be numeric, found: $patch" >&2
            exit 1
          fi
          new_patch=$((patch + 1))
          new_version="${major}.${minor}.${new_patch}"
          sed -i "s/^version: .*/version: ${new_version}/" "$chart_file"
          git add "$chart_file"
          git commit -m "chore: bump chart version to ${new_version}"
          git push origin "HEAD:${TARGET_BRANCH}"
          echo "version=${new_version}" >> "$GITHUB_OUTPUT"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.3

      - name: Lint chart
        run: helm lint charts/paperless-ngx

      - name: Ensure CHARTS_REPO_TOKEN exists
        env:
          CHARTS_REPO_TOKEN: ${{ secrets.CHARTS_REPO_TOKEN }}
        run: |
          if [ -z "${CHARTS_REPO_TOKEN}" ]; then
            echo "CHARTS_REPO_TOKEN fehlt. Lege ein PAT mit Contents: Read/Write auf olqs-org/charts an." >&2
            exit 1
          fi 

      - name: Release chart
        uses: helm/chart-releaser-action@v1.7.0
        env:
          CR_TOKEN: ${{ secrets.CHARTS_REPO_TOKEN }}
          CR_OWNER: olqs-org
          CR_GIT_REPO: charts
        with:
          charts_dir: charts
          packages_with_index: true
          skip_existing: true

      - name: Refresh Artifact Hub repository
        env:
          ARTIFACTHUB_REPOSITORY: ${{ secrets.ARTIFACTHUB_REPOSITORY }}
          ARTIFACTHUB_API_KEY: ${{ secrets.ARTIFACTHUB_API_KEY }}
        run: |
          if [ -z "$ARTIFACTHUB_REPOSITORY" ] || [ -z "$ARTIFACTHUB_API_KEY" ]; then
            echo "Artifact Hub secrets missing, skipping refresh."
            exit 0
          fi
          curl -sSf \
            -X POST \
            -H "Authorization: Bearer ${ARTIFACTHUB_API_KEY}" \
            "https://artifacthub.io/api/v1/repositories/refresh/helm/${ARTIFACTHUB_REPOSITORY}"
