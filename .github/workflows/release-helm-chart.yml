name: Release Helm Chart

on:
  push:
  pull_request:
    branches:
      - main
    types:
      - closed
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:
  lint-and-release:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    env:
      TARGET_BRANCH: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.ref || github.ref_name }}
      MERGE_COMMIT: ${{ github.event_name == 'pull_request' && github.event.pull_request.merge_commit_sha || github.sha }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ env.MERGE_COMMIT }}
          fetch-depth: 0

      - name: Prepare repository
        run: |
          git fetch origin "$TARGET_BRANCH"
          git checkout "$TARGET_BRANCH"
          git pull --ff-only origin "$TARGET_BRANCH"

      - name: Ensure gh-pages branch exists
        run: |
          if git ls-remote --exit-code origin gh-pages; then
            git fetch origin gh-pages:refs/remotes/origin/gh-pages
          else
            git checkout --orphan gh-pages
            git reset --hard
            git commit --allow-empty -m "chore: initialize gh-pages branch"
            git push origin gh-pages
            git checkout "$TARGET_BRANCH"
          fi

      - name: Configure Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump chart version
        id: bump_version
        run: |
          chart_file="charts/paperless-ngx/Chart.yaml"
          current_version=$(grep '^version:' "$chart_file" | awk '{print $2}')
          IFS='.' read -r major minor patch <<<"$current_version"
          if [ -z "$major" ] || [ -z "$minor" ] || [ -z "$patch" ]; then
            echo "Unable to parse current chart version: $current_version" >&2
            exit 1
          fi
          if ! [[ $patch =~ ^[0-9]+$ ]]; then
            echo "Chart patch version must be numeric, found: $patch" >&2
            exit 1
          fi
          new_patch=$((patch + 1))
          new_version="${major}.${minor}.${new_patch}"
          sed -i "s/^version: .*/version: ${new_version}/" "$chart_file"
          git add "$chart_file"
          git commit -m "chore: bump chart version to ${new_version}"
          git push origin "HEAD:${TARGET_BRANCH}"
          echo "version=${new_version}" >> "$GITHUB_OUTPUT"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.3

      - name: Lint chart
        run: helm lint charts/paperless-ngx

      - name: Release chart
        uses: helm/chart-releaser-action@v1.6.0
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          charts_dir: charts
          packages_with_index: true
          skip_existing: true
